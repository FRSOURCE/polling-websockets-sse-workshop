<html>

<head>
  <title>Express</title>
</head>

<body>
  <h1>Express</h1>
  <p>Welcome to Express</p>

  <div class="chat"></div>
  <form id="new-message-form">
    <input type="text" name="message"/>
    <button>submit</button>
  </form>

  <script>
    const chatBox = document.querySelector('.chat');

    const evtSource = new EventSource('/messages');

    const updateChatBox = (messages) => {
      let newMessagesListHTML = '';
      messages.forEach(({ created, content }) => {
        newMessagesListHTML += `<p><i>${new Date(created).toLocaleString()}</i>&nbsp; ${content}</p>`;
      });

      chatBox.innerHTML += newMessagesListHTML;
    };

    evtSource.addEventListener('message', function(e) {
      const messages = JSON.parse(e.data);

      updateChatBox(messages);
    });

    const postMessage = (content) =>
      fetch('/messages', { method: 'POST', body: JSON.stringify({ content }), headers: { 'Content-Type': 'application/json' } })
    
    document.querySelector('#new-message-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      await postMessage(this.elements.message.value);
      this.elements.message.value = '';
    });
  </script>
</body>

</html>
